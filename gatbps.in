#!/bin/sh
LC_ALL=C
export LC_ALL

case "${1}" in
  --help|--hel|--he|--h)
    cat <<'EOF' || exit 1
Usage: gatbps [FILE]...
Create project management files.

Each FILE is classified by its name as either regular or special. There
is a fixed list of special FILE names, which is printed if no arguments
are given. Any other FILE is regular.

Each regular FILE is created by adding startup and shutdown code to
FILE.texi and calling makeinfo --plaintext. If FILE.top exists, it is
prepended to FILE. Otherwise, if FILE.top.texi exists, it is processed
in the same way as FILE.texi and prepended to FILE. The same action is
taken for FILE.bot(.texi), but appending to FILE instead of prepending.

Each special FILE is filled with either preset code or information
collected from version control. Among other things, this allows for the
creation of a version string, release date, authors list, and changelog.

Try 'man gatbps' or 'info gatbps' for more information.
EOF
    exit 0
    ;;
  --version|--versio|--versi|--vers|--ver|--ve|--v)
    cat <<'EOF' || exit 1
gatbps (GATBPS) @PACKAGE_VERSION@
This version was released on @PACKAGE_DATE@.
The authors of this script have waived all copyright and
related or neighboring rights to the extent permitted by
law as described by the CC0 1.0 Universal Public Domain
Dedication. You should have received a copy of the full
dedication along with this script, typically as a file
named <CC0-1.0.txt>. If not, it may be available at
<https://creativecommons.org/publicdomain/zero/1.0/>.
EOF
    exit 0
    ;;
  --)
    shift
    ;;
  --help=*|--hel=*|--he=*|--h=*)
    cat <<'EOF' >&2
gatbps: option '--help' doesn't allow an argument
Try 'gatbps --help' for more information.
EOF
    exit 1
    ;;
  --version=*|--versio=*|--versi=*|--vers=*|--ver=*|--ve=*|--v=*)
    cat <<'EOF' >&2
gatbps: option '--version' doesn't allow an argument
Try 'gatbps --help' for more information.
EOF
    exit 1
    ;;
  --=*)
    cat <<EOF >&2
gatbps: option '${1}' is ambiguous; possibilities: '--help' '--version'
Try 'gatbps --help' for more information.
EOF
    exit 1
    ;;
  --*|-?)
    cat <<EOF >&2
gatbps: unrecognized option '${1}'
Try 'gatbps --help' for more information.
EOF
    exit 1
    ;;
  -?*)
    x=`expr "X${1}" : 'X\(-.\)' 2>/dev/null`
    case "${?}" in
      0)
        s=''
        case "${x}" in
          -)
            x='-
'
            ;;
        esac
        ;;
      *)
        s='s'
        x="${1}"
        ;;
    esac
    cat <<EOF >&2
gatbps: unrecognized option${s} '${x}'
Try 'gatbps --help' for more information.
EOF
    exit 1
    ;;
esac

case "${#}" in
  0)
    cat <<'EOF' || exit 1
CC0-1.0.txt
EOF
    exit 0
    ;;
esac

gatbps_do_texi_helper() {
  cat <<'EOF' >"${2}.gatbps1" || return 1
\input texinfo
@setfilename foo
@settitle foo
@documentencoding UTF-8
EOF
  cat "${1}" >>"${2}.gatbps1" || return 1
  cat <<'EOF' >>"${2}.gatbps1" || return 1
@bye
EOF
  makeinfo --plaintext "${2}.gatbps1" >"${2}" || return 1
  rm -f "${2}.gatbps1"
  return 0
}

gatbps_do_texi() {
  gatbps_do_texi_helper "${1}" "${2}" && return 0
  rm -f "${2}" "${2}.gatbps1"
  return 1
}

gatbps_do_top_helper() {
  sed '/^#/d' "${1}" >"${2}" || return 1
  echo '' >>"${2}" || return 1
  return 0
}

gatbps_do_top() {
  gatbps_do_top_helper "${1}" "${2}" && return 0
  rm -f "${2}"
  return 1
}

gatbps_do_top_texi_helper() {
  gatbps_do_texi "${1}" "${2}.gatbps1" || return 1
  echo '' >>"${2}.gatbps1" || return 1
  cat "${2}.gatbps1" >"${2}" || return 1
  rm -f "${2}.gatbps1"
  return 0
}

gatbps_do_top_texi() {
  gatbps_do_top_texi_helper "${1}" "${2}" && return 0
  rm -f "${2}" "${2}.gatbps1"
  return 1
}

gatbps_do_bot_helper() {
  echo '' >"${2}" || return 1
  sed '/^#/d' "${1}" >>"${2}" || return 1
  return 0
}

gatbps_do_bot() {
  gatbps_do_bot_helper "${1}" "${2}" && return 0
  rm -f "${2}"
  return 1
}

gatbps_do_bot_texi_helper() {
  echo '' >"${2}.gatbps1" || return 1
  gatbps_do_texi "${1}" "${2}.gatbps2" || return 1
  cat "${2}.gatbps1" "${2}.gatbps2" >"${2}.gatbps3" || return 1
  mv -f "${2}.gatbps3" "${2}" || return 1
  rm -f "${2}.gatbps1" "${2}.gatbps2"
  return 0
}

gatbps_do_bot_texi() {
  gatbps_do_bot_texi_helper "${1}" "${2}" && return 0
  rm -f "${2}.gatbps1" "${2}.gatbps2" "${2}.gatbps3"
  return 1
}

error=0
for arg do
  case "${arg}" in
    /*)
      file="${arg}"
      ;;
    *)
      file="./${arg}"
      ;;
  esac
  name=`expr "X${file}" : 'X.*/\(.*\)' '|' X`
  case "${?}" in
    0)
      :
      ;;
    *)
      error=1
      continue
      ;;
  esac
  case "${name}" in
    *)
      :
      ;;
  esac
done
exit "${error}"

#
# The authors of this file have waived all copyright and
# related or neighboring rights to the extent permitted by
# law as described by the CC0 1.0 Universal Public Domain
# Dedication. You should have received a copy of the full
# dedication along with this file, typically as a file
# named <CC0-1.0.txt>. If not, it may be available at
# <https://creativecommons.org/publicdomain/zero/1.0/>.
#
